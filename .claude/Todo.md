---

  📋 실전 예측 데이터 생성 계획

  현재 시스템 구조 파악

  Predictor 입력 요구사항:

- Feature DataFrame이 필요 (약 20개 이상의 컬럼)
- 필수 Features:
  - 가격 기반: gap_pct, prev_return, volume_ratio 등
  - 기술적 지표: rsi_14, atr_14, ma_5/20/50, bollinger_position 등
  - 시장 컨텍스트: market_gap_diff, spy_gap_pct, qqq_gap_pct 등

  Feature 생성에 필요한 원본 데이터:

1. 해당 종목의 과거 OHLCV 데이터 (최소 50일, 넉넉히 60일)
2. 오늘의 시장 지수 데이터 (SPY, QQQ 등의 시가)
3. 선택적으로 뉴스/실적 데이터

---

  🔄 실전 예측 데이터 생성 흐름도

  ┌─────────────────────────────────────────────────────────────────┐
  │                  1단계: 카프카 메시지 수신                        │
  ├─────────────────────────────────────────────────────────────────┤
  │  메시지 내용:                                                    │
  │  {                                                              │
  │    "symbol": "AAPL",                                            │
  │    "date": "2026-01-13",                                        │
  │    "open": 150.50,                                              │
  │    "prev_close": 145.00,                                        │
  │    "InfoCode": "A005930"  (DB 연결용 코드)                       │
  │  }                                                              │
  │                                                                 │
  │  → 오늘 아침 갭 상승 종목 리스트 (10~100개)                       │
  └─────────────────────────────────────────────────────────────────┘
                              ↓
  ┌─────────────────────────────────────────────────────────────────┐
  │              2단계: 예측에 필요한 과거 데이터 수집                 │
  ├─────────────────────────────────────────────────────────────────┤
  │  2-1. 종목별 과거 OHLCV 데이터 조회 (DB)                         │
  │       - InfoCode로 쿼리                                          │
  │       - 기간: today - 60일 ~ yesterday                           │
  │       - 컬럼: date, open, high, low, close, volume              │
  │       - 결과: 60일치 일봉 데이터                                  │
  │                                                                 │
  │  2-2. 오늘의 시장 지수 데이터 조회 (DB 또는 API)                  │
  │       - SPY, QQQ의 오늘 시가 + 어제 종가                         │
  │       - 갭 계산: (오늘 시가 - 어제 종가) / 어제 종가 × 100       │
  │                                                                 │
  │  2-3. (선택) 뉴스/실적 데이터 조회                                │
  │       - 최근 24시간 뉴스 건수, 센티먼트 스코어                     │
  │       - 실적 발표일 여부 확인                                     │
  └─────────────────────────────────────────────────────────────────┘
                              ↓
  ┌─────────────────────────────────────────────────────────────────┐
  │                   2단계: Feature 생성                            │
  ├─────────────────────────────────────────────────────────────────┤
  │  2-1. 가격 기반 Features 계산                                    │
  │       입력: 과거 60일 OHLCV + 오늘 open                          │
  │       계산:                                                      │
  │       - gap_pct = (open - prev_close) / prev_close × 100        │
  │       - prev_return = (prev_close - prev_open) / prev_open × 100│
  │       - volume_ratio = prev_volume / avg_volume_20d             │
  │       - prev_range_pct, prev_upper_shadow 등                    │
  │                                                                 │
  │  2-2. 기술적 지표 Features 계산 (TechnicalFeatures 클래스)       │
  │       입력: 과거 60일 OHLCV                                      │
  │       계산:                                                      │
  │       - RSI(14일), ATR(14일), Bollinger Bands                   │
  │       - 이동평균(5, 20, 50일), 크로스 여부                        │
  │       - 모멘텀(5일, 20일 수익률), 연속 상승일                     │
  │       → ⚠️ 모두 "전일까지" 데이터로 계산 (Look-ahead 방지)        │
  │                                                                 │
  │  2-3. 시장 컨텍스트 Features 계산 (MarketFeatures 클래스)        │
  │       입력: 오늘의 시장 지수 갭                                   │
  │       계산:                                                      │
  │       - market_gap_diff = 종목 gap_pct - SPY gap_pct            │
  │       - spy_gap_pct, qqq_gap_pct 병합                           │
  │                                                                 │
  │  2-4. (선택) 이벤트 Features                                     │
  │       - is_earnings_day, news_count_24h 등                      │
  │                                                                 │
  │  최종 출력:                                                      │
  │  DataFrame with 1 row × 20+ columns (종목당)                    │
  │  [gap_pct, prev_return, rsi_14, atr_14, market_gap_diff, ...]  │
  └─────────────────────────────────────────────────────────────────┘
                              ↓
  ┌─────────────────────────────────────────────────────────────────┐
  │                 3단계: Predictor로 예측                          │
  ├─────────────────────────────────────────────────────────────────┤
  │  입력: Feature DataFrame (N개 종목 × 20+ features)               │
  │                                                                 │
  │  predictor.predict(features_df)                                 │
  │                                                                 │
  │  출력:                                                           │
  │  {                                                              │
  │    "prob_up": 0.72,              # 상승 확률                     │
  │    "prob_down": 0.28,            # 하락 확률                     │
  │    "return_if_up": 2.5,          # 상승 시 예상 수익률 (%)       │
  │    "return_if_down": -1.8,       # 하락 시 예상 손실률 (%)       │
  │    "expected_return": 1.3,       # 기대 수익률 (%)               │
  │    "predicted_direction": 1,     # 1=상승, 0=하락                │
  │    "max_return_if_up": 3.8,      # (선택) 고가 예상 수익률       │
  │    "take_profit_target": 3.0     # (선택) 익절 목표              │
  │  }                                                              │
  └─────────────────────────────────────────────────────────────────┘
                              ↓
  ┌─────────────────────────────────────────────────────────────────┐
  │                   4단계: 예측 결과 DB 저장                        │
  ├─────────────────────────────────────────────────────────────────┤
  │  저장할 테이블: gap_predictions (예시)                            │
  │                                                                 │
  │  컬럼 구조:                                                      │
  │  - id (PK)                                                      │
  │  - InfoCode (종목 코드)                                          │
  │  - symbol (티커)                                                 │
  │  - date (예측 날짜)                                              │
  │  - gap_pct (갭 %)                                               │
  │  - prob_up (상승 확률)                                           │
  │  - expected_return (기대 수익률)                                 │
  │  - return_if_up (상승 시 예상 수익률)                             │
  │  - return_if_down (하락 시 예상 손실률)                           │
  │  - predicted_direction (예측 방향)                               │
  │  - max_return_if_up (고가 예상)                                  │
  │  - take_profit_target (익절 목표)                                │
  │  - predicted_at (예측 시각, timestamp)                           │
  │  - model_version (모델 버전)                                     │
  │                                                                 │
  │  + 실전 활용 컬럼:                                               │
  │  - actual_return (실제 수익률, 장마감 후 업데이트)                 │
  │  - is_correct (예측 성공 여부, 장마감 후)                         │
  │  - signal (BUY/HOLD, 필터링 조건 적용 후)                        │
  └─────────────────────────────────────────────────────────────────┘

---

  🔑 핵심 포인트

1. 데이터 수집 전략

  종목별 과거 데이터:

- 필요 기간: 최소 50일, 권장 60일
- 이유: RSI(14일), ATR(14일), MA(50일), Bollinger(20일) 계산에 필요
- 조회 시점: 오늘 아침 장 시작 전 (프리마켓 이후)
- 병렬 처리: 100개 종목이면 100개 쿼리 동시 실행 (DB 부하 주의)

  시장 지수 데이터:

- SPY, QQQ의 오늘 시가와 어제 종가만 있으면 됨
- 갭 계산: (오늘 시가 - 어제 종가) / 어제 종가 × 100
- 가장 중요한 Feature인 market_gap_diff 계산에 필수

2. Feature 계산 주의사항

  Look-ahead Bias 방지:

- 모든 기술적 지표는 "전일까지" 데이터로 계산
- 오늘의 시가(open)만 새로운 정보로 사용
- 현재 TechnicalFeatures 클래스가 이미 .shift(1) 처리되어 있음

  계산 순서:

1. 과거 60일 OHLCV → 기술적 지표 계산 (RSI, ATR, MA 등)
2. 오늘 row 추가 (date=today, open=새 값, close=NaN)
3. 가격 기반 Features 계산 (gap_pct, prev_return 등)
4. 시장 Features 병합 (market_gap_diff)
5. 오늘 row만 추출 → Predictor 입력

  누락 데이터 처리:

- 신규 상장 종목 (과거 60일 부족): 계산 불가, 예측 스킵
- 시장 지수 데이터 없음: market_gap_diff = NaN → 예측 품질 저하
- 뉴스 데이터 없음: Phase 1에서는 무시 가능

3. 실전 배치 최적화

  성능 고려사항:

- 100개 종목 × 60일 데이터 조회 = 6,000 rows
- Feature 계산: 병렬 처리 가능 (종목별 독립적)
- 예측: 한 번에 100개 종목 batch 처리 (빠름)
- 목표 처리 시간: 전체 5분 이내

  캐싱 전략:

- 시장 지수 데이터는 하루 1회만 조회 (재사용)
- 종목별 과거 데이터는 메모리에 로드 (반복 조회 방지)
- Predictor 모델은 최초 1회만 로드 (재사용)

4. 데이터 품질 검증

  필수 체크 포인트:

- Feature에 NaN 비율 확인 (> 50%면 경고)
- market_gap_diff가 NaN인 경우 처리 방안
- 극단값 제거: gap_pct > 50% 또는 < -50%
- 모델 입력 Feature 개수 일치 확인

---

  📊 예시 시나리오

  오늘 아침 9:00 AM (프리마켓 종료 후):

  카프카 메시지:

- AAPL: open=$150.50, prev_close=$145.00 (갭 +3.79%)
- TSLA: open=$220.00, prev_close=$215.00 (갭 +2.33%)
- NVDA: open=$510.00, prev_close=$505.00 (갭 +0.99%)
  ... 총 87개 종목

  → DB 조회:
    - 각 종목의 과거 60일 OHLCV
    - SPY 오늘 시가 $450.00, 어제 종가 $448.00 (SPY 갭 +0.45%)

  → Feature 계산:
    - AAPL: gap_pct=3.79, market_gap_diff=3.34 (3.79-0.45)
    - AAPL: rsi_14=65.2 (어제까지 데이터로 계산)
    - AAPL: atr_14=3.50 (어제까지 데이터로 계산)
    ... 20개 features

  → Predictor 예측:
    - AAPL: prob_up=0.75, expected_return=+1.8%
    - TSLA: prob_up=0.68, expected_return=+1.2%
    - NVDA: prob_up=0.52, expected_return=+0.3%

  → DB 저장:
    - gap_predictions 테이블에 87개 row INSERT
    - 상위 20개 종목 필터링 → 매매 신호 생성

---

⚠️ 주요 리스크 및 대응
  ┌───────────────────────┬───────────────────────────────────────┐
  │        리스크         │               대응 방안               │
  ├───────────────────────┼───────────────────────────────────────┤
  │ DB 조회 시간 지연     │ 인덱스 최적화, 병렬 쿼리, 캐싱        │
  ├───────────────────────┼───────────────────────────────────────┤
  │ 시장 지수 데이터 누락 │ 전날 SPY 갭으로 대체, 또는 0으로 가정 │
  ├───────────────────────┼───────────────────────────────────────┤
  │ Feature NaN 과다      │ 최소 데이터 기준 설정 (예: 40일 이상) │
  ├───────────────────────┼───────────────────────────────────────┤
  │ 모델 로딩 시간        │ 서버 시작 시 미리 로드, 메모리 상주   │
  ├───────────────────────┼───────────────────────────────────────┤
  │ 극단적 갭 (>50%)      │ 필터링 제외 또는 별도 처리            │
  └───────────────────────┴───────────────────────────────────────┘
------------------------------------------------------------------------------------------------------------------------------------

  이 계획이 명확한가요? 구현 단계로 넘어가기 전에 추가 질문이나 수정 사항이 있나요?
